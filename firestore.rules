rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Users Collection ---
    // Rules for the 'users' collection
    match /users/{userId} {
      // An admin can read any user document.
      // A user can only read their own document.
      allow read: if request.auth.uid == userId
                  || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // An admin can write to any user document.
      // A user can only write to their own document.
      allow write: if request.auth.uid == userId
                   || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // --- Reward Requests Subcollection ---
      // Rules for the 'reward_requests' subcollection within each user
      match /reward_requests/{requestId} {
        // An admin can read/write any request.
        // A user can only create/read their own requests.
        allow read, write: if request.auth.uid == userId
                           || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
    }
    
    // --- Game Settings ---
    // Rules for the global game settings document
    match /game_settings/main {
        // Any authenticated user can read the game date.
        allow read: if request.auth != null;
        
        // Only admins can write/update the game date.
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // --- Collection Group for Reward Requests ---
    // This allows admins to query the 'reward_requests' across all users.
    match /{path=**}/reward_requests/{requestId} {
        // Admins can list all requests across all users.
        allow list, read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
