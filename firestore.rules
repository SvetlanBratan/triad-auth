
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // --- Specific Rules ---

    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if isOwner(userId);
      
      // Admins can do anything.
      // Users can update their own doc, but not increase points or change role.
      // Users can update OTHER users' docs, but not change points or role (for gifts/letters).
      allow update: if isAdmin() || (request.auth != null &&
                       request.resource.data.role == resource.data.role &&
                       (isOwner(userId) ? request.resource.data.points <= resource.data.points : request.resource.data.points == resource.data.points)
                     );
      
      // Only admin can delete users
      allow delete: if isAdmin();

      match /reward_requests/{requestId} {
        allow read, create: if isOwner(userId);
        allow update, delete: if isAdmin();
      }
    }
    
    match /{path=**}/reward_requests/{requestId} {
      allow read: if isAdmin();
    }

    match /exchange_requests/{requestId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == request.resource.data.creatorUserId;
      allow update: if request.auth != null && (isAdmin() || resource.data.creatorUserId == request.auth.uid || request.resource.data.status == 'closed');
      allow delete: if request.auth != null && (isAdmin() || resource.data.creatorUserId == request.auth.uid);
    }

    match /familiar_trade_requests/{requestId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == request.resource.data.initiatorUserId;
      allow update: if request.auth != null && (
                      isAdmin() ||
                      (request.auth.uid == resource.data.initiatorUserId && request.resource.data.status == 'отменено') ||
                      (request.auth.uid == resource.data.targetUserId && (request.resource.data.status == 'принято' || request.resource.data.status == 'отклонено'))
                    );
    }
    
    match /shops/{shopId} {
        allow read: if true;
        allow write: if request.auth != null && (isAdmin() || resource.data.ownerUserId == request.auth.uid);
    }

    match /alchemy_recipes/{recipeId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }

    match /familiars/{familiarId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }

    match /game_settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- Generic Rules for other collections to prevent breakage ---
    // These rules allow any logged-in user to perform actions.
    
    match /applications/{docId} { allow read, write: if request.auth != null; }
    match /posts/{docId} { allow read, write: if request.auth != null; }
    match /races/{docId} { allow read, write: if request.auth != null; }
    match /library/{docId} { allow read, write: if request.auth != null; }
    match /history/{docId} { allow read, write: if request.auth != null; }
    match /aristocracy_titles/{docId} { allow read, write: if request.auth != null; }
    match /feudal_territories/{docId} { allow read, write: if request.auth != null; }
    match /celebrities/{docId} { allow read, write: if request.auth != null; }
    match /flora_fauna/{docId} { allow read, write: if request.auth != null; }
    match /newspapers/{docId} { allow read, write: if request.auth != null; }
    match /world_status/{docId} { allow read, write: if request.auth != null; }
    match /professions/{docId} { allow read, write: if request.auth != null; }
    match /guilds/{docId} { allow read, write: if request.auth != null; }
    match /calendar/{docId} { allow read, write: if request.auth != null; }
    match /economy/{docId} { allow read, write: if request.auth != null; }
    match /faq/{docId} { allow read, write: if request.auth != null; }
    match /social_links/{docId} { allow read, write: if request.auth != null; }
    match /locations/{docId} { allow read, write: if request.auth != null; }
    match /news_links/{docId} { allow read, write: if request.auth != null; }
    match /laws/{docId} { allow read, write: if request.auth != null; }
    match /advertising/{docId} { allow read, write: if request.auth != null; }
    match /stories/{docId} { allow read, write: if request.auth != null; }
    match /storyApplications/{docId} { allow read, write: if request.auth != null; }
    match /story_suggestions/{docId} { allow read, write: if request.auth != null; }
    match /bulletin_board/{docId} { allow read, write: if request.auth != null; }
  }
}
